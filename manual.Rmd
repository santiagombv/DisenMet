---
title: "Diseños metodológicos y su aplicación en el campo"
author: "Santiago Benitez-Vieyra"
lang: spanish
output: 
  pdf_document:
    latex_engine: xelatex
    toc: yes
    toc_depth: 1
---

\pagebreak

#Introducción

Los datos más comunes en biología muchas veces no pueden ser analizados utilizando los modelos aprendidos en los cursos básicos de estadística. Mientras las estadísticas básicas descansan en modelos de datos de distribución normal, en biología los datos son habitualmente de naturaleza binaria (presencia o ausencia en un sitio, éxito reproductivo, estatus de infección de los individuos de una población), proporciones (proporciones sexuales, de infección o de mortalidad) o conteos (número de individuos). Por otra parte, los problemas biológicos a menudo involucran efectos aleatorios como bloques, medidas repetidas  o estudios observacionales replicados en el tiempo o el espacio.    
Los investigadores muchas veces intentan transformar datos para lograr la normalidad y homogeneidad de varianzas, utilizan pruebas no paramétricas o confían en la robustez de los modelos lineales generales. También suelen ignorar los efectos aleatorios o los tratan como si fueran fijos. Muchas de estas estrategias pueden fallar o, incluso si son exitosas, violan supuestos estadísticos o limitan el alcance de las inferencias. Este curso pretende extender las capacidades de los alumnos para lidiar con este tipo de datos y de elegir una herramienta estadística adecuada a cada situación.    
Finalmente, se hace una introducción a técnicas multivariadas comunes (análisis de componentes principales y de agrupamiento) que representan las principales herramientas del aprendizaje estadístico no supervisado. En estos casos la variable respuesta no ha sido establecida de antemano y son necesarias herramientas para conocer, resumir o descubrir agrupamientos internos en los datos.    

\pagebreak

#Practico1. Datos de conteo I. Regresion de Poisson.   

Los datos del archivo hormigas.txt corresponden a un estudio donde se pretende determinar si la riqueza de especies de hormigas  (Srich) es afectada por el tipo de hábitat (Habitat), la latitud (Latitude) y la elevación (Elevation). Dado que la riqueza de especies es claramente un dato de conteo, se propone utilizar un modelo lineal generalizado con estructura de errores Poisson.   

##Caso1
```{r, eval=FALSE}
ants <- read.table("C:/RD/hormigas.txt", header = TRUE)
#	ants <- read.table(file = file.choose(), header = TRUE)

# modelo
gfit1 <- glm(Srich ~ Habitat + Latitude + Elevation, data = ants, family = poisson)

# Tabla "tipo regresión" valores de los parámetros y prueba de Wald
summary(gfit1)

# Tabla de análisis de la devianza
anova(gfit1, test = "Chisq")

#significancia del modelo completo (cociente de verosimilitud)
gfit0 <- glm(Srich ~ 1, data = ants, family = poisson (link = log))
anova(gfit0, gfit1, test = "Chisq")

#DIAGNÓSTICOS COMUNES
layout(matrix(1:4, 2, 2))
plot(gfit1)
layout(1)

library(car)
vif(gfit1)

#DIAGNÓSTICOS PARA MLG
# 1¿Es adecuada la relación media-varianza? (¿es el parámetro de   
# dispersión = a 1?)
gfit2 <- glm(Srich ~ Habitat + Latitude + Elevation, data = ants, 
             family = quasipoisson(link=log))

summary(gfit2)
anova(gfit2, test = "F")

# 2 ¿Es adecuado el enlace?
PL <- gfit1$linear.predictors^2
gfit3 <- glm(Srich ~ Habitat + Latitude + Elevation + PL, data=ants,
             family = poisson(link=log))
summary(gfit3)

# INTERPRETACIÓN DE LOS PARÁMETROS
be <- gfit1$coefficients
exp(be)

IC <- confint(gfit1)
exp(IC)
```

## Ejercicios

1. Utilizar el archivo "tasa visitas.txt" para examinar si el número de abejas halíctidas (n.halict) es influenciado por el número de flores de la planta (flores) y la intensidad de la fragancia producida por las flores (frag). Ajustar el modelo completo, examinar la colinealidad de las variables, probar la presencia de sobredispersión, probar la adecuación del enlace, seleccionar el modelo más adecuado, interpretar los gráficos de bondad de ajuste y los parámetros del modelo.   

2. Utilizando solamente el número de flores de la planta y  el número de abejas visitantes del conjunto de datos anterior, construya un modelo sencillo y utilícelo para realizar un gráfico.   

3. Utilizar el archivo horseshoe crab.txt para examinar si el número de machos satélite (nsatellites) es influenciado por características de las hembras de cangrejo herradura (resto de las variables). Ajustar el modelo completo, examinar la colinealidad de las variables, probar la presencia de sobredispersión, probar la adecuación del enlace, seleccionar el modelo más adecuado, interpretar los gráficos de bondad de ajuste y los parámetros del modelo.   

4. Utilizar los datos del archivo cyclop.txt para ajustar un modelo binomial negativo (función `glm.nb` del paquete `MASS`) donde se pruebe si el número de polinarios exportados por una orquídea (pol.exp) es afectado por variables morfológicas de la planta (nectario, flores, largo.ext). Utilizar una prueba de cociente de verosimilitud para examinar si el modelo binomial negativo es mejor que el modelo poisson. El desarrollo de la prueba se adjunta abajo.   
        
```{r, eval=FALSE}
L.po<-logLik(nombre_del_modelo_poisson)
L.nb<-logLik(nombre_del_modelo_binomial_neg)
d<-2*(L.nb-L.po)
d
pchisq(d[1], df=1, lower.tail=F)/2
```

\pagebreak

#Práctico 2. Regresión para datos binomiales agregados y no agregados.

##Caso 1.
A lotes con distintas cantidades de moscas (tot) se les aplicó 3 tipos de veneno (veneno) a distintas dosis (dosis) y se contabilizó el número de moscas muertas (muertos). Se intenta conocer cuál es el veneno más efectivo. Dado que la variable respuesta es una proporción (moscas muertas / moscas totales) se propone un modelo lineal generalizado con estructura de errores binomial para datos agregados.   
   
```{r, eval=FALSE}
ven <- read.table("C:/RD/veneno.txt", header = TRUE)
#  ven <- read.table(file = file.choose(), header = TRUE)

# construcción de la variable respuesta
rta <- cbind(ven$muertos, ven$tot-ven$muertos)

#modelo
vfit <- glm(rta ~ veneno + dosis, data = ven, family = binomial(logit))

#significancia según el estadístico de Wald
summary(vfit)

#análisis de la devianza 
anova(vfit, test = "Chisq")

#examen gráfico de los residuos
layout(matrix(1:4, 2, 2))
plot(vfit)
layout(1)

#examen sobre la presencia de sobredispersión
vfit2 <- glm(rta ~ veneno + dosis, data = ven, family = quasibinomial(logit))
summary(vfit2)

#examen sobre la pertinencia del enlace
LP <- vfit$linear.predictors^2
vfit3 <- glm(rta ~ veneno + dosis + LP, data = ven, family = binomial(logit))
summary(vfit3)

#INTERPRETACIÓN DE PARÁMETROS
exp(vfit$coeff)

# parámetros faltantes:
# paso 1) estimación de la matriz de variaza-covarianza de los estimadores
VCM <- vcov(vfit)
VCM

# paso 2) estimación de la comparación faltante (veneno M vs. veneno R)
be <- vfit$coeff
veMR <- (be[2] - be[3]) 
exp(veMR)
1/exp(veMR)

# paso 3) estimación de su significancia (prueba de wald)
chi.veRM <- ((be[2] - be[3])^2)/(vcov(vfit)[2, 2]+vcov(vfit)[3, 3] 
                                 - 2*vcov(vfit)[2, 3])
pchisq(chi.veRM, 1, lower.tail = FALSE)

# ACLARACIÓN 1: el programa reporta los valores z para el estadístico de
# Wald. La misma prueba se puede hacer usando z^2 y probabilidades chi 2

# ACLARACIÓN 2: el mismo resultado puede lograrse reordenando los
# niveles del factor.

ven$veneno2 <- factor(ven$veneno, levels = c('R', 'M', 'D'))
reor.vfit <- glm(rta ~ veneno2 + dosis, family = binomial(logit), data = ven)
summary(reor.vfit)
exp(reor.vfit$coeff)
1/exp(reor.vfit$coeff)

```
    
## Caso 2.
El archivo uta.txt contiene datos de un estudio donde se examinó la presencia de lagartijas del género Uta en 19 islas de Baja California. Se desea probar si la presencia de lagartijas (Uta: 0 = ausentes, 1= presentes) depende de la relación perímetro/área de las islas (PA.ratio).    
Dado que los datos son de naturaleza binaria, se propone aplicar un modelo lineal generalizado con estructura de errores binomial, para datos no agregados (regresión logística).   

```{r, eval=FALSE}
datos <- read.table("C:/RD/uta.txt", header = TRUE)
#	datos <- read.table(file = file.choose(), header = TRUE)

#modelo
fit <- glm(Uta ~ PA.ratio, data = datos, family = binomial(logit))

#parámetros y su significancia según el estadístico de Wald
summary(fit)

#análisis de la devianza 
anova(fit, test = "Chisq")

#examen gráfico de los residuos
layout(matrix(1:4, 2, 2))
plot(fit)
layout(1)

#examen sobre la pertinencia del enlace
LP <- fit$linear.predictors^2
fit3 <- glm(Uta ~ PA.ratio + LP, data = datos, family = binomial(logit))
summary(fit3)

#gráfico con predict
X <- data.frame(PA.ratio = seq(0, 64, 0.5))
Y <- predict(fit, X, type = "response")
plot(Uta ~ PA.ratio, data = datos, xlab = "perímetro/área", ylab = "presencia de Uta")
points(X$PA.ratio, Y, type = "l")

```

##Ejercicios
1. El archivo budworm.txt contiene los resultados de un experimento donde a lotes de 20 gusanos del tabaco (Number) machos o hembras (Gender) se les aplicó un veneno en distintas concentraciones (Dose) y se examinó cuántos se morían (Killed). Examinar:   
    + ¿Existe un efecto de la dosis de veneno sobre la mortalidad de los gusanos?
    + ¿Existe un efecto del sexo?
    + ¿Modifica el sexo del gusano su respuesta a dosis crecientes de veneno?   

2. El archivo miners.txt contiene datos de la presencia de un ave invasiva (miners) en 31 sitios y de la cantidad de eucaliptos por hectárea en esos sitios (eucs), que fueron implantados en un programa de reforestación.   
    + ¿Hay un efecto del número de eucaliptos sobre la presencia de miners?
    + ¿Cuál sería el intervalo de confianza para ese efecto?
    + Realizar un gráfico para representar los resultados.   

3. El archivo toxo.txt muestra el número de individuos afectados por toxoplasmosis (Infected), el número de individuos examinados (Sampled) y la precipitación anual en 34 ciudades de El Salvador.   
    + ¿Hay un efecto de la lluvia sobre la ocurrencia de toxoplasmosis?
    + ¿A qué nivel de lluvia se espera que la mitad de la población se halle infectada?   

    
\pagebreak
